<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Program Exerciții cu Timer</title>

  <!-- Manifest and Icons -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" sizes="192x192" type="image/png" />
  <link rel="apple-touch-icon" href="icon-180.png" sizes="180x180" />

  <!-- PWA Meta -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#ffffff" />

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
    }
    #exerciseText {
      margin: 20px 0;
      white-space: pre-line;
    }
    #timer {
      font-size: 48px;
      text-align: center;
      margin: 10px 0;
    }
    #status {
      font-size: 20px;
      text-align: center;
      margin: 10px 0;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 16px;
    }
    select {
      font-size: 16px;
      padding: 5px;
    }
  </style>
</head>
<body>

<h1>Program Exerciții</h1>

<label for="daySelect">Alege ziua:</label>
<select id="daySelect"></select>

<div id="exerciseText"></div>

<div id="timer">00:00</div>
<div id="status">Așteaptă să începi...</div>

<div style="text-align:center;">
  <button id="startBtn">Start</button>
  <button id="playPauseBtn">Play/Pauză</button>
  <button id="skipBtn">Skip</button>
</div>

<script>
  const program = [
    { day: 1, exercise: "Zi libera", duration: 0 },
    { day: 2, exercise: "Plimbare 30 de minute", duration: 30 * 60 },
    { day: 3, exercise: "Plimbare 30 de minute", duration: 30 * 60 },
    { day: 4, exercise: "Plimbare 30 de minute", duration: 30 * 60 },
    { day: 5, exercise: "Zi libera", duration: 0 },
    { day: 6, exercise: "Plimbare 30 de minute", duration: 30 * 60 },
    { day: 7, exercise: "Zi libera", duration: 0 },
    { day: 8, exercise: `Mers rapid 3 min
alergare ușoară 1 min
Mers rapid 3 minute
alergare ușoară 1 min
Mers rapid 3 min
alergare ușoară 1 min
Mers rapid 3 min
alergare ușoară 1 min
Mers rapid 3 min
alergare ușoară 1 min`, duration: 20 * 60 },
    { day: 9, exercise: `Mers rapid 3 min
alergare ușoară 1 min
Mers rapid 3 minute
alergare ușoară 1 min
Mers rapid 3 min
alergare ușoară 1 min
Mers rapid 3 min
alergare ușoară 1 min
Mers rapid 3 min
alergare ușoară 1 min`, duration: 20 * 60 },
    { day: 10, exercise: `Mers rapid 3 min
alergare ușoară 1 min
Mers rapid 3 minute
alergare ușoară 1 min
Mers rapid 3 min
alergare ușoară 1 min
Mers rapid 3 min
alergare ușoară 1 min
Mers rapid 3 min
alergare ușoară 1 min`, duration: 20 * 60 },
    { day: 11, exercise: "Plimbare 30 de minute", duration: 30 * 60 },
    { day: 12, exercise: `Mers rapid 3 min
alergare ușoară 2 min
Mers rapid 3 minute
alergare ușoară 2 min
Mers rapid 3 min
alergare ușoară 2 min
Mers rapid 3 min
alergare ușoară 2 min`, duration: 25 * 60 },
    { day: 13, exercise: `Mers rapid 3 min
alergare ușoară 2 min
Mers rapid 3 minute
alergare ușoară 2 min
Mers rapid 3 min
alergare ușoară 2 min
Mers rapid 3 min
alergare ușoară 2 min`, duration: 25 * 60 },
    { day: 14, exercise: "Zi libera", duration: 0 },
    { day: 15, exercise: `Mers rapid 3 min
alergare ușoară 2 min
Mers rapid 3 minute
alergare ușoară 2 min
Mers rapid 3 min
alergare ușoară 2 min
Mers rapid 3 min
alergare ușoară 3 min
Mers rapid 3 min
alergare ușoară 3 min`, duration: 27 * 60 },
    { day: 16, exercise: `Mers rapid 3 min
alergare ușoară 2 min
Mers rapid 3 minute
alergare ușoară 2 min
Mers rapid 3 min
alergare ușoară 2 min
Mers rapid 3 min
alergare ușoară 2 min
Mers rapid 3 min
alergare ușoară 2 min`, duration: 30 * 60 },
    { day: 17, exercise: "Plimbare 30 de minute", duration: 30 * 60 },
    { day: 18, exercise: `Mers rapid 2 min
alergare ușoară 3 min
Mers rapid 2 min
alergare ușoară 3 min
Mers rapid 2 min
alergare ușoară 3 min
Mers rapid 2 min
alergare ușoară 3 min
Mers rapid 2 min
alergare ușoară 3 min`, duration: 25 * 60 },
    { day: 19, exercise: "Plimbare 30 de minute", duration: 30 * 60 },
    { day: 20, exercise: `Mers rapid 2 min
alergare ușoară 5 min
Mers rapid 2 min
alergare ușoară 5 min
Mers rapid 3 min
alergare ușoară 3 min
Mers rapid 3 min
alergare ușoară 3 min
Mers rapid 3 min
alergare ușoară 3 min`, duration: 32 * 60 },
    { day: 21, exercise: "Zi libera", duration: 0 },
    { day: 22, exercise: `Mers rapid 3 min
alergare ușoară 5 min
Mers rapid 3 min
alergare ușoară 5 min
Mers rapid 4 min
alergare ușoară 10 min`, duration: 30 * 60 },
    { day: 23, exercise: `Mers rapid 3 min
alergare ușoară 10 min
Mers rapid 3 min
alergare ușoară 10 min
Mers rapid 3 min
alergare ușoară 10 min`, duration: 39 * 60 },
    { day: 24, exercise: "Plimbare 30 de minute", duration: 30 * 60 },
    { day: 25, exercise: `Mers rapid 3 min
alergare ușoară 10 min
Mers rapid 3 min
alergare ușoară 10 min
Mers rapid 4 min
alergare ușoară 5 min
Mers rapid 4 min
alergare ușoară 5 min`, duration: 44 * 60 },
    { day: 26, exercise: "Zi libera", duration: 0 },
    { day: 27, exercise: `Mers rapid 5 min
alergare ușoară 5 min
Mers rapid 4 min
alergare ușoară 15 min
Mers rapid 4 min
alergare ușoară 15 min`, duration: 48 * 60 },
    { day: 28, exercise: "Zi libera", duration: 0 },
  ];
  const daySelect = document.getElementById("daySelect");
  const exerciseText = document.getElementById("exerciseText");
  const timerEl = document.getElementById("timer");
  const statusEl = document.getElementById("status");
  const startBtn = document.getElementById("startBtn");
  const playPauseBtn = document.getElementById("playPauseBtn");
  const skipBtn = document.getElementById("skipBtn");

  let currentDay = 1;
  let routineSteps = [];
  let currentStepIndex = 0;
  let stepRemaining = 0;
  let timerInterval = null;
  let isPlaying = false;

  let synth = window.speechSynthesis;
  let voices = [];
  let voice = null;

  // ✅ Create AudioContext once (for iOS reliability)
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function loadVoices() {
    voices = synth.getVoices();
    let v = voices.find(v => v.lang.startsWith('ro') && (v.name.toLowerCase().includes("alex") || v.name.toLowerCase().includes("male")));
    if (!v) v = voices.find(v => v.lang.startsWith('ro'));
    if (!v && voices.length) v = voices[0];
    return v;
  }

  function speak(text) {
    if (!synth) return;
    synth.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.voice = voice;
    utter.lang = "ro-RO";
    utter.rate = 1;
    utter.pitch = 0.9;
    synth.speak(utter);
  }

  // ✅ Reuse AudioContext for better iOS support
  function playBeep() {
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(1000, audioCtx.currentTime);
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.start();
    gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.3);
    oscillator.stop(audioCtx.currentTime + 0.3);
  }

  function updateTimerDisplay(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    timerEl.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  }

  function parseRoutine(text) {
    if (!text || text.toLowerCase().includes("liber")) return [];
    const lines = text.split("\n");
    const steps = [];
    const regex = /(mers rapid|alergare ușoară|plimbare)\s*(\d+)\s*(min|minute)/i;
    for (const line of lines) {
      const m = line.match(regex);
      if (m) {
        const label = m[1].charAt(0).toUpperCase() + m[1].slice(1).toLowerCase();
        const min = parseInt(m[2]);
        steps.push({ label, duration: min * 60 });
      }
    }
    return steps;
  }

  function nextStep() {
    currentStepIndex++;
    if (currentStepIndex >= routineSteps.length) {
      stopTimer();
      statusEl.textContent = "Exercițiul s-a terminat!";
      speak("Exercițiul s-a terminat!");
      return;
    }
    startStep();
  }

  function startStep() {
    if (routineSteps.length === 0) {
      statusEl.textContent = "Zi liberă. Nu există exerciții.";
      timerEl.textContent = "00:00";
      return;
    }
    const step = routineSteps[currentStepIndex];
    stepRemaining = step.duration;
    statusEl.textContent = step.label;
    speak(step.label);
    updateTimerDisplay(stepRemaining);
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      if (!isPlaying) return;
      stepRemaining--;
      updateTimerDisplay(stepRemaining);
      if (stepRemaining > 0 && stepRemaining <= 5) {
        playBeep();
      }
      if (stepRemaining <= 0) {
        nextStep();
      }
    }, 1000);
  }

  function startTimer() {
    if (routineSteps.length === 0) {
      statusEl.textContent = "Zi liberă. Nu există exerciții.";
      timerEl.textContent = "00:00";
      return;
    }
    isPlaying = true;
    startStep();
  }

  function stopTimer() {
    isPlaying = false;
    currentStepIndex = 0;
    if (timerInterval) clearInterval(timerInterval);
    timerEl.textContent = "00:00";
  }

  function populateDays() {
    for (const d of program) {
      const option = document.createElement("option");
      option.value = d.day;
      option.textContent = `Ziua ${d.day}`;
      daySelect.appendChild(option);
    }
  }

  function loadDay(day) {
    stopTimer();
    currentDay = day;
    const dayData = program.find(d => d.day === day);
    if (!dayData) return;
    exerciseText.textContent = dayData.exercise;
    routineSteps = parseRoutine(dayData.exercise);
    currentStepIndex = 0;
    statusEl.textContent = "Așteaptă să începi...";
    timerEl.textContent = "00:00";
  }

  startBtn.onclick = () => {
    if (!isPlaying) startTimer();
  };

  playPauseBtn.onclick = () => {
    if (!routineSteps.length) return;
    isPlaying = !isPlaying;
    statusEl.textContent = isPlaying ? routineSteps[currentStepIndex]?.label || "Continuare..." : "Pauză";
  };

  skipBtn.onclick = () => {
    if (!routineSteps.length) return;
    nextStep();
  };

  daySelect.onchange = () => {
    loadDay(parseInt(daySelect.value));
  };

  document.addEventListener('DOMContentLoaded', () => {
    populateDays();
    daySelect.value = 1;
    loadDay(1);

    voice = loadVoices();
    if (synth.onvoiceschanged !== undefined) {
      synth.onvoiceschanged = () => {
        voice = loadVoices();
      };
    }
  });
</script>

</body>
</html>
